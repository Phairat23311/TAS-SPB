<script>
    // ... ส่วนเริ่มต้นเดิม ...

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = document.getElementById('username').value.trim();
        const pass = document.getElementById('password').value;
        const rememberMe = document.getElementById('rememberMe').checked;
        const btn = document.getElementById('btnSubmit');
        const originalBtnContent = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ตรวจสอบ...';

        try {
            // ดึงข้อมูล User
            const { data, error } = await sbClient.from(TAS_CONFIG.TABLE_USER).select('*').eq('personnel_id', user).single();
            
            // --- ปรับปรุงใหม่: Silent Check ---
            // ต่อให้ Error หรือไม่พบ User เราจะยังไม่แจ้งเตือนที่นี่ แต่จะเก็บสถานะไว้
            const userExists = data && !error;
            const dbPass = userExists ? (data.Password || "") : "dummy_pass"; // ใช้รหัสหลอกถ้าไม่พบ user
            const isFirstTime = userExists && (dbPass === "" || dbPass === String(user));

            // กรณีต้องเข้าหน้ากรอกรหัสลับ (First Time หรือ รหัสผ่านว่าง)
            if (!userExists || isFirstTime) {
                const { value: secret } = await Swal.fire({
                    title: 'ยืนยันตัวตน',
                    text: 'กรุณาระบุโค้ดลับ (ติดต่อ Admin เพื่อรับโค้ด)',
                    input: 'text',
                    inputPlaceholder: 'กรอกโค้ดลับที่นี่...',
                    showCancelButton: true,
                    confirmButtonColor: '#4f46e5'
                });

                // ตรวจสอบรหัสลับ (ชื่อ-สกุล)
                if (userExists && secret === data.name) {
                    const { value: newPass } = await Swal.fire({
                        title: 'ตั้งรหัสผ่านใหม่',
                        input: 'password',
                        inputPlaceholder: 'ระบุรหัสผ่านใหม่',
                        confirmButtonText: 'บันทึก',
                        inputAttributes: { minlength: 4 },
                        inputValidator: (v) => {
                            if (!v) return 'กรุณาระบุรหัสผ่าน';
                            // --- ปรับปรุงใหม่: ห้ามใช้รหัสบุคลากรเป็น Password ---
                            if (v === String(user)) return 'ห้ามใช้รหัสบุคลากรเป็นรหัสผ่าน';
                        }
                    });

                    if (newPass) {
                        await sbClient.from(TAS_CONFIG.TABLE_USER).update({ Password: newPass }).eq('personnel_id', user);
                        data.Password = newPass;
                        proceedLogin(data, rememberMe, true);
                    } else {
                        throw new Error("ยกเลิกการตั้งรหัสผ่าน");
                    }
                } else {
                    // หาก User ไม่มีจริง หรือ รหัสลับผิด ให้แสดงข้อความรวมๆ เพื่อไม่ให้รู้จุดผิด
                    throw new Error("ข้อมูลยืนยันตัวตนไม่ถูกต้อง หรือรหัสลับผิดพลาด");
                }
            } 
            // กรณีเข้าสู่ระบบปกติ
            else {
                if (String(dbPass) === String(pass)) {
                    proceedLogin(data, rememberMe, false);
                } else {
                    throw new Error("รหัสพนักงานหรือรหัสผ่านไม่ถูกต้อง");
                }
            }

        } catch (err) {
            Swal.fire({ icon: 'error', title: 'เข้าสู่ระบบไม่สำเร็จ', text: err.message, confirmButtonColor: '#4f46e5' });
            btn.disabled = false;
            btn.innerHTML = originalBtnContent;
        }
    });

    function proceedLogin(userData, rememberMe, isNewUser) {
        localStorage.setItem('tas_user', JSON.stringify(userData));
        if (rememberMe) localStorage.setItem('tas_remember', 'true');
        
        Swal.fire({
            icon: 'success',
            title: 'สำเร็จ',
            text: 'กำลังเข้าสู่ระบบ...',
            timer: 1500,
            showConfirmButton: false
        }).then(() => {
            // ถ้าเป็นคนตั้งรหัสใหม่ให้ไปหน้า Profile เพื่อตรวจความเรียบร้อย
            window.location.href = isNewUser ? 'profile.html' : 'menu.html';
        });
    }
</script>
