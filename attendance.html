<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô - TAS-SPB</title>
    
    <style>
        body { font-family: sans-serif; background-color: #f3f4f6; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .header { width: 100%; max-width: 400px; display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 0.9rem; color: #4b5563; }
        .logout { color: #ef4444; cursor: pointer; text-decoration: underline; border: none; background: none; font-size: 0.9rem; }
        
        .card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        
        .date-display { font-size: 1.1rem; color: #374151; margin-bottom: 0.5rem; font-weight: bold; }
        .db-date-format { font-size: 0.8rem; color: #9ca3af; margin-bottom: 1.5rem; font-family: monospace; }
        
        .clock-box { background-color: #f3f4f6; border-radius: 12px; padding: 1rem; margin-bottom: 2rem; }
        .clock { font-size: 3rem; font-family: monospace; font-weight: bold; color: #1f2937; letter-spacing: 2px; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .btn { padding: 1.2rem; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; color: white; cursor: pointer; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-in { background-color: #22c55e; } 
        .btn-in:hover { background-color: #16a34a; }
        .btn-out { background-color: #f97316; }
        .btn-out:hover { background-color: #ea580c; }
        
        .status-area { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; font-size: 0.9rem; color: #4b5563; }
        .status-row { display: flex; justify-content: space-between; align-items: center; margin-top: 0.8rem; }
        .time-val { font-weight: bold; color: #111827; font-family: monospace; font-size: 1.1rem; }
        
        /* üî• ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
        .btn-edit {
            background-color: #fff;
            border: 1px solid #d1d5db;
            color: #4b5563;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .btn-edit:hover { background-color: #f3f4f6; border-color: #9ca3af; }
        
        #msg { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 100; }
    </style>

    <script src="supabase.js"></script>
</head>
<body>

    <div id="msg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>

    <div class="header">
        <div>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="userName" style="color: #2563eb; font-weight: bold;">...</span></div>
        <button class="logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="card">
        <div class="date-display" id="humanDate">-</div>
        <div class="db-date-format">DB Format: <span id="dbDateDisplay">-</span></div>
        
        <div class="clock-box">
            <div class="clock" id="clockDisplay">00:00:00</div>
        </div>

        <div class="btn-group">
            <button class="btn btn-in" onclick="recordTime('in')">üïí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>
            <button class="btn btn-out" onclick="recordTime('out')">üè† ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>
        </div>

        <div class="status-area">
            <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏à‡∏≤‡∏Å DB):</div>
            
            <div class="status-row">
                <span>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤:</span>
                <div>
                    <span id="timeInDisplay" class="time-val">-</span>
                    <button class="btn-edit" onclick="editTime('time_in')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>

            <div class="status-row">
                <span>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å:</span>
                <div>
                    <span id="timeOutDisplay" class="time-val">-</span>
                    <button class="btn-edit" onclick="editTime('time_out')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://tdcmbskmlrwhbjrjyjkk.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkY21ic2ttbHJ3aGJqcmp5amtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTY4NTYsImV4cCI6MjA3ODE5Mjg1Nn0.FeYe75J8X_2LoQgG_JWyPNCKcuCL_otsmSW0s5bijAg";
        
        let client = null;
        let userData = null;
        let currentRecord = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Record ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

        function showToast(text, isError = false) {
            const msg = document.getElementById('msg');
            msg.innerText = text;
            msg.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
            msg.style.opacity = '1';
            setTimeout(() => { msg.style.opacity = '0'; }, 3000);
        }

        function generateID() {
            const now = new Date();
            const yy = String(now.getFullYear());
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            const r = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `${yy}${mm}${dd}${h}${m}${s}${r}`;
        }

        function init() {
            try {
                const stored = localStorage.getItem('tas_user');
                if (!stored) {
                    window.location.href = 'login.html';
                    return;
                }
                userData = JSON.parse(stored);
                document.getElementById('userName').innerText = userData.name || userData.personnel_id;

                if (typeof window.supabase === 'undefined') {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå supabase.js");
                    return;
                }
                client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                startClock();
                loadTodayRecord();

            } catch (e) {
                console.error(e);
                window.location.href = 'login.html';
            }
        }

        function getDBFormatValues() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            return {
                date: `${year}-${month}-${day}`, 
                time: `${hours}:${minutes}:${seconds}`, 
                obj: now
            };
        }

        function startClock() {
            setInterval(() => {
                const val = getDBFormatValues();
                document.getElementById('clockDisplay').innerText = val.time;
                document.getElementById('dbDateDisplay').innerText = val.date;
                document.getElementById('humanDate').innerText = val.obj.toLocaleDateString('th-TH', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            }, 1000);
            
            const val = getDBFormatValues();
            document.getElementById('clockDisplay').innerText = val.time;
        }

        async function loadTodayRecord() {
            if (!client) return;
            const val = getDBFormatValues();
            const todayDB = val.date;

            try {
                const { data, error } = await client
                    .from('TimeStampPlus')
                    .select('*')
                    .eq('personnel_id', userData.personnel_id)
                    .eq('work_date', todayDB)
                    .single();

                if (data) {
                    currentRecord = data; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
                    document.getElementById('timeInDisplay').innerText = data.time_in || "-";
                    document.getElementById('timeOutDisplay').innerText = data.time_out || "-";
                    return data;
                } else {
                    currentRecord = null;
                    document.getElementById('timeInDisplay').innerText = "-";
                    document.getElementById('timeOutDisplay').innerText = "-";
                    return null;
                }
            } catch (err) {
                if (err.code !== 'PGRST116') console.error(err);
                currentRecord = null;
                return null;
            }
        }

        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤ (Manual Edit)
        async function editTime(field) {
            if (!client) return;
            
            // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Record ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
            if (!currentRecord) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ‡∏´‡∏£‡∏∑‡∏≠ '‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ");
                return;
            }

            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Prompt
            const oldVal = field === 'time_in' ? currentRecord.time_in : currentRecord.time_out;
            const defaultVal = oldVal || "08:00:00"; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 08:00:00

            // ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å
            const newVal = prompt(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤ ${field === 'time_in' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' : '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô'} (HH:MM:SS)`, defaultVal);

            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î Cancel ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏£
            if (newVal === null) return;
            if (newVal.trim() === "") {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤");
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Format ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ (HH:MM:SS)
            const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9](:[0-5][0-9])?$/;
            if (!timeRegex.test(newVal)) {
                alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö HH:MM:SS (‡πÄ‡∏ä‡πà‡∏ô 08:30:00)");
                return;
            }

            try {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡∏ó‡∏µ‡πà‡∏à‡∏∞ update
                const updateData = {};
                updateData[field] = newVal; // ‡πÄ‡∏ä‡πà‡∏ô { time_in: '09:00:00' }

                const { error } = await client
                    .from('TimeStampPlus')
                    .update(updateData)
                    .eq('id', currentRecord.id);

                if (error) throw error;

                showToast("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                loadTodayRecord(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á

            } catch (err) {
                console.error(err);
                showToast("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message, true);
            }
        }

        async function recordTime(type) {
            if (!client) return;
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${type === 'in' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô'} ?`)) return;

            const val = getDBFormatValues();
            const todayDB = val.date;
            const timeDB = val.time; 

            try {
                const existing = await loadTodayRecord();
                let error = null;
                const newID = generateID();

                if (type === 'in') {
                    if (existing) {
                        const { error: upError } = await client
                            .from('TimeStampPlus')
                            .update({ time_in: timeDB })
                            .eq('id', existing.id);
                        error = upError;
                    } else {
                        const { error: insError } = await client
                            .from('TimeStampPlus')
                            .insert([{
                                id: newID,
                                personnel_id: userData.personnel_id,
                                full_name: userData.name,
                                work_date: todayDB,
                                time_in: timeDB
                            }]);
                        error = insError;
                    }
                } else { // type === 'out'
                    if (existing) {
                        const { error: upError } = await client
                            .from('TimeStampPlus')
                            .update({ time_out: timeDB })
                            .eq('id', existing.id);
                        error = upError;
                    } else {
                        const { error: insError } = await client
                            .from('TimeStampPlus')
                            .insert([{
                                id: newID,
                                personnel_id: userData.personnel_id,
                                full_name: userData.name,
                                work_date: todayDB,
                                time_out: timeDB
                            }]);
                        error = insError;
                    }
                }

                if (error) throw error;

                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                loadTodayRecord();

            } catch (err) {
                console.error(err);
                showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message, true);
            }
        }

        function logout() {
            localStorage.removeItem('tas_user');
            window.location.href = 'login.html';
        }

        init();
    </script>
</body>
</html>
