<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานประจำวัน - TAS-SPB</title>
    <style>
        @font-face {
            font-family: 'THSarabunNew';
            src: url('font/THSarabunNew.ttf') format('truetype');
            font-weight: normal; font-style: normal;
        }
        @font-face {
            font-family: 'THSarabunNew';
            src: url('font/THSarabunNew Bold.ttf') format('truetype');
            font-weight: bold; font-style: normal;
        }

        :root { 
            --paper-w: 210mm; --paper-h: 297mm;
            --pad-top: 20mm; --pad-bottom: 20mm; --pad-left: 30mm; --pad-right: 20mm;
            --content-w: calc(var(--paper-w) - var(--pad-left) - var(--pad-right));
            --half-w: calc(var(--content-w) / 2);
            /* แนวเส้นหน้าคอลัมน์ "ลงเวลากลับ" */
            --col-back-line: calc(var(--half-w) + 75px);
        }
        
        body { font-family: 'THSarabunNew', sans-serif; background: #525659; margin: 0; }
        
        .paper { 
            width: var(--paper-w); height: var(--paper-h); background: white; 
            padding: var(--pad-top) var(--pad-right) var(--pad-bottom) var(--pad-left);
            margin: 10mm auto; position: relative; display: flex; flex-direction: column;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        /* หัวกระดาษ: ตัดขึ้นบรรทัดใหม่เมื่อเจอเว้นวรรค */
        .rpt-header { text-align: center; margin-bottom: 8mm; line-height: 1.2; }
        .rpt-title { 
            font-size: 18pt; font-weight: bold; 
            white-space: pre-line; /* รองรับการขึ้นบรรทัดใหม่จากวรรคที่ส่งมาจาก JS */
            word-break: keep-all; 
        }
        .rpt-sub { font-size: 18pt; }

        /* ตาราง */
        .rpt-table { width: 100%; border-collapse: collapse; border: 1.5px solid black; table-layout: fixed; }
        .rpt-table th, .rpt-table td { border: 1px solid black; font-size: 16pt; height: 26.5px; vertical-align: middle; }
        .col-id { width: 45px; text-align: center; }
        .col-name { width: calc(var(--half-w) - 45px); }
        .col-time { width: 75px; text-align: center; }

        /* ท้ายตาราง */
        .footer-content { margin-top: 3.5mm; width: 100%; font-size: 16pt; }
        .summary-grid { 
            display: grid; 
            grid-template-columns: var(--col-back-line) 1fr; 
            line-height: 1.3;
        }

        /* สรุปยอดฝั่งซ้าย: ถ้าชื่อยาวให้ตัดแล้วเติม ฯ */
        .summary-left {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis; /* แสดง ฯ เมื่อยาวเกิน (อาศัย CSS หรือจัดการผ่าน JS ต่อ) */
            padding-right: 5px;
        }

        .signature-area { width: 100%; text-align: center; margin-top: 10mm; font-size: 16pt; line-height: 1.5; }
        
        @media print {
            body { background: none; } .paper { margin: 0; box-shadow: none; page-break-after: always; }
        }
    </style>
</head>
<body>
    <div id="reportWrapper"></div>

    <script>
        const ROWS_PER_PAGE = 29;

        // ฟังก์ชันตัดคำและเติม ฯ สำหรับท้ายตาราง
        function truncateTypeName(name, maxLength = 35) {
            if (name.length > maxLength) {
                return name.substring(0, maxLength) + "ฯ";
            }
            return name;
        }

        async function loadData() {
            // ... (โค้ดดึงข้อมูลจาก Supabase คงเดิม) ...
            
            // ตัวอย่าง Loop สร้างหน้า
            Object.keys(groups).forEach(type => {
                const sortedList = groups[type];
                const totalPages = Math.ceil(sortedList.length / ROWS_PER_PAGE);

                for(let p = 0; p < totalPages; p++) {
                    const pageEl = document.createElement('div');
                    pageEl.className = 'paper';
                    
                    // หัวเรื่อง: เปลี่ยน " " (space) เป็น "\n" (ขึ้นบรรทัดใหม่)
                    const headerFullText = `บันทึกการลงเวลาปฏิบัติงานของ\n${type}`;

                    pageEl.innerHTML = `
                        <div class="rpt-header">
                            <div class="rpt-title">${headerFullText}</div>
                            <div class="rpt-sub">วันพุธที่ 24 ธันวาคม พ.ศ. 2568</div>
                        </div>
                        <table class="rpt-table">
                            <thead>
                                <tr>
                                    <th class="col-id">ที่</th>
                                    <th class="col-name">ชื่อ-สกุล</th>
                                    <th class="col-time">มา</th>
                                    <th class="col-time">กลับ</th>
                                    <th style="width:auto;">หมายเหตุ</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    `;

                    if (p === totalPages - 1) {
                        const footer = document.createElement('div');
                        footer.className = 'footer-content';
                        
                        // ท้ายตาราง: ตรวจสอบความยาวชื่อประเภท
                        const displayType = truncateTypeName(type);

                        footer.innerHTML = `
                            <div class="summary-grid">
                                <div class="summary-left">
                                    ${displayType} ทั้งหมด ${sortedList.length} คน<br>
                                    ตำแหน่งว่าง - คน<br>
                                    ไปราชการ - คน<br>
                                    ไม่มาปฏิบัติราชการ - คน
                                </div>
                                <div>
                                    มาสาย - คน<br>
                                    ยืมตัวมาช่วยราชการ - คน<br>
                                    มาปฏิบัติราชการ ${sortedList.length} คน
                                </div>
                            </div>
                            <div class="signature-area">
                                <div>(ลงชื่อ)............................................................</div>
                                <div>(นางกาญจนา จันทมัตตุการ)</div>
                                <div>ผู้อำนวยการสถานศึกษา</div>
                            </div>
                        `;
                        pageEl.appendChild(footer);
                    }
                    document.getElementById('reportWrapper').appendChild(pageEl);
                }
            });
        }
        loadData();
    </script>
</body>
</html>
