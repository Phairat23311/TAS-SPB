<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏ß‡∏•‡∏≤ - TAS-SPB</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f8fafc; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 600px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; }
        .btn-process { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; padding: 15px 30px; border-radius: 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin: 20px 0; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3); transition: transform 0.2s; }
        .btn-process:active { transform: scale(0.95); }
        .btn-process:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }
        .log-box { text-align: left; background: #1e293b; color: #334155; border-radius: 10px; padding: 15px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; border: 1px solid #e2e8f0; color: #10b981; }
        .back-btn { text-decoration: none; color: #64748b; font-weight: bold; display: inline-block; margin-bottom: 20px; }
    </style>
    
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <a href="menu.html" class="back-btn">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>

    <div class="container">
        <h2>üîÑ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
        <p>‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å <b>Web</b> ‡πÅ‡∏•‡∏∞ <b>Data URL</b><br>‡∏Ñ‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á <b>TimeStamp</b></p>
        
        <button id="btnStart" class="btn-process" onclick="startProcess()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
        
        <div class="log-box" id="logDisplay">
            > ‡∏£‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...
        </div>
    </div>

    <script>
        const user = checkAuth(); // ‡πÄ‡∏ä‡πá‡∏Ñ Level 1

        function log(msg) {
            const box = document.getElementById('logDisplay');
            box.innerHTML += `<div>> ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        async function startProcess() {
            const btn = document.getElementById('btnStart');
            btn.disabled = true;
            document.getElementById('logDisplay').innerHTML = '<div>> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£...</div>';

            try {
                // 1. ‡∏î‡∏∂‡∏á URL ‡∏à‡∏≤‡∏Å Settings
                log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Data URL...");
                const { data: settingData } = await sbClient.from(TAS_CONFIG.TABLE_SETTINGS)
                    .select('value').eq('key', 'data_url').single();

                let externalData = [];
                if (settingData && settingData.value) {
                    log(`‡∏û‡∏ö URL: ${settingData.value}`);
                    log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å...");
                    try {
                        const res = await fetch(settingData.value);
                        if(res.ok) externalData = await res.json();
                        else log("‚ùå ‡πÇ‡∏´‡∏•‡∏î External Data ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Ç‡πâ‡∏≤‡∏°)");
                    } catch(e) { log("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ URL ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏Ç‡πâ‡∏≤‡∏°)"); }
                } else {
                    log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö key='data_url' ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ (‡∏Ç‡πâ‡∏≤‡∏°)");
                }
                log(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å: ${externalData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

                // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å TimeStampPlus (‡πÉ‡∏ô Supabase)
                log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å TimeStampPlus...");
                const { data: internalData, error: errInt } = await sbClient
                    .from(TAS_CONFIG.TABLE_SOURCE) // TimeStampPlus
                    .select('*');
                
                if (errInt) throw errInt;
                log(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô: ${internalData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

                // 3. ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Merge Logic)
                log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ß‡∏•‡∏≤...");
                const mergedMap = {};

                const processRecord = (record) => {
                    // ‡πÉ‡∏ä‡πâ Personnel_ID + Work_Date ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà
                    const key = `${record.personnel_id}_${record.work_date}`;

                    if (!mergedMap[key]) {
                        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                        mergedMap[key] = {
                            id: generateID(), // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡∏°‡πà
                            personnel_id: record.personnel_id,
                            full_name: record.full_name || record.name,
                            work_date: record.work_date,
                            time_in: record.time_in,
                            time_out: record.time_out
                            // verified: ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏° Default ‡∏Ç‡∏≠‡∏á DB
                        };
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ (Merge)
                        const current = mergedMap[key];

                        // 1. ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤: ‡πÄ‡∏≠‡∏≤‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà "‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤" (‡πÄ‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤)
                        if (record.time_in) {
                            if (!current.time_in || record.time_in < current.time_in) {
                                current.time_in = record.time_in;
                            }
                        }

                        // 2. ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å: ‡πÄ‡∏≠‡∏≤‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà "‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤" (‡∏î‡∏∂‡∏Å‡∏Å‡∏ß‡πà‡∏≤/‡πÄ‡∏¢‡πá‡∏ô‡∏Å‡∏ß‡πà‡∏≤)
                        if (record.time_out) {
                            if (!current.time_out || record.time_out > current.time_out) {
                                current.time_out = record.time_out;
                            }
                        }
                    }
                };

                // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á 2 ‡πÅ‡∏´‡∏•‡πà‡∏á
                externalData.forEach(rec => processRecord(rec));
                internalData.forEach(rec => processRecord(rec));

                const finalData = Object.values(mergedMap);
                log(`‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${finalData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

                // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á TimeStamp (Upsert)
                if (finalData.length > 0) {
                    log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á TimeStamp...");
                    
                    // üî• Upsert ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á personnel_id + work_date
                    const { error: errUpsert } = await sbClient
                        .from(TAS_CONFIG.TABLE_TARGET) // TimeStamp
                        .upsert(finalData, { onConflict: 'personnel_id, work_date' });

                    if (errUpsert) throw errUpsert;
                    
                    log("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${finalData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
                } else {
                    log("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
                }

            } catch (err) {
                console.error(err);
                log(`‚ùå Error: ${err.message}`);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
