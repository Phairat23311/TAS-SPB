<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏ß‡∏•‡∏≤ - TAS-SPB</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f8fafc; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 700px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; }
        .btn-process { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none; padding: 15px 30px; border-radius: 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin: 20px 0; box-shadow: 0 4px 6px rgba(99, 102, 241, 0.3); transition: transform 0.2s; }
        .btn-process:active { transform: scale(0.95); }
        .btn-process:disabled { background: #cbd5e1; cursor: not-allowed; }
        .log-box { text-align: left; background: #1e293b; color: #10b981; border-radius: 10px; padding: 15px; height: 350px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; border: 1px solid #e2e8f0; }
        .back-btn { text-decoration: none; color: #64748b; font-weight: bold; display: inline-block; margin-bottom: 20px; }
        .highlight { color: #fbbf24; } 
        .error { color: #ef4444; } 
        .info { color: #60a5fa; }
    </style>
    
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <a href="menu.html" class="back-btn">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>

    <div class="container">
        <h2>üîÑ ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á HTML</h2>
        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (HTTP) <br>‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ß‡πá‡∏ö</p>
        
        <button id="btnStart" class="btn-process" onclick="startProcess()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
        
        <div class="log-box" id="logDisplay">
            > ‡∏£‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...
        </div>
    </div>

    <script>
        const user = checkAuth();

        function log(msg, type = 'normal') {
            const box = document.getElementById('logDisplay');
            let colorClass = '';
            if(type === 'highlight') colorClass = 'class="highlight"';
            if(type === 'error') colorClass = 'class="error"';
            if(type === 'info') colorClass = 'class="info"';
            
            box.innerHTML += `<div ${colorClass}>> ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function formatDateDB(date) {
            const pad = (n) => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
        }

        // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö URL ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà DDMMYYYY
        function formatDateURL(date) {
            const pad = (n) => String(n).padStart(2, '0');
            return `${pad(date.getDate())}${pad(date.getMonth() + 1)}${date.getFullYear()}`;
        }

        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á HTML ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Scraping Logic)
        function parseHTMLTable(htmlString, dateStr) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, "text/html");
            const table = doc.getElementById('mainTable');
            const records = [];

            if (!table) return [];

            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length >= 4) {
                    const pid = cols[0].innerText.trim();
                    const name = cols[1].innerText.trim();
                    let t_in = cols[2].innerText.trim();
                    let t_out = cols[3].innerText.trim();

                    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô null (‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏°)
                    if(t_in === "" || t_in === "-") t_in = null;
                    else if(t_in.length === 5) t_in += ":00"; // 08:30 -> 08:30:00

                    if(t_out === "" || t_out === "-") t_out = null;
                    else if(t_out.length === 5) t_out += ":00";

                    if (pid) {
                        records.push({
                            personnel_id: pid,
                            full_name: name,
                            work_date: dateStr, // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Loop
                            time_in: t_in,
                            time_out: t_out
                        });
                    }
                }
            });
            return records;
        }

        async function startProcess() {
            const btn = document.getElementById('btnStart');
            btn.disabled = true;
            document.getElementById('logDisplay').innerHTML = '<div>> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£...</div>';

            try {
                // 1. ‡∏î‡∏∂‡∏á Base URL ‡∏à‡∏≤‡∏Å Settings
                const { data: settingData } = await sbClient.from(TAS_CONFIG.TABLE_SETTINGS)
                    .select('value').eq('key', 'data_url').single();
                
                let baseURL = "";
                // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô DB ‡πÄ‡∏õ‡πá‡∏ô https://att4... ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô http ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô proxy
                if (settingData && settingData.value) {
                    // ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô proxy ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà url ‡∏î‡∏¥‡∏ö
                    let rawUrl = settingData.value.replace("https://api.allorigins.win/raw?url=", "");
                    // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ Proxy ‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô HTTP
                    baseURL = `https://api.allorigins.win/get?url=${encodeURIComponent(rawUrl)}`;
                    log(`Proxy URL: ${baseURL}...`, 'info');
                } else {
                    log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö data_url ‡πÉ‡∏ô Settings (‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏≠‡∏Å)");
                }

                // 2. ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...");
                const { data: latestRecord } = await sbClient.from(TAS_CONFIG.TABLE_TARGET)
                    .select('work_date').order('work_date', { ascending: false }).limit(1).single();

                let startDate = new Date();
                if (latestRecord && latestRecord.work_date) {
                    startDate = new Date(latestRecord.work_date);
                    log(`üìÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDateDB(startDate)}`, 'highlight');
                } else {
                    log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏≤‡∏Å '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'");
                }

                // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ
                const today = new Date();
                today.setHours(0,0,0,0);
                startDate.setHours(0,0,0,0);
                let loopDate = new Date(startDate); 

                while (loopDate <= today) {
                    const dateDBStr = formatDateDB(loopDate);   // YYYY-MM-DD
                    const dateURLPart = formatDateURL(loopDate); // DDMMYYYY
                    
                    log(`-----------------------------------`);
                    log(`‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateDBStr} ...`, 'highlight');

                    // 3.1 ‡∏î‡∏∂‡∏á Web ‡∏ô‡∏≠‡∏Å (‡∏ú‡πà‡∏≤‡∏ô Proxy & Parse HTML)
                    let externalData = [];
                    if (baseURL) {
                        try {
                            // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏ó‡πâ‡∏≤‡∏¢ url)
                            // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Base ‡πÉ‡∏ô DB: http://att4.doomdns.com/rp/SPWTQtSA/
                            // ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: http://att4.doomdns.com/rp/SPWTQtSA/29122025
                            
                            // ‡∏î‡∏∂‡∏á URL ‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å Setting ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
                            let cleanBase = settingData.value;
                            if(cleanBase.includes("allorigins")) {
                                // ‡∏ñ‡πâ‡∏≤ user ‡πÄ‡∏ú‡∏•‡∏≠‡πÉ‡∏™‡πà proxy ‡πÑ‡∏õ‡πÉ‡∏ô db ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡∏∞‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
                                const match = cleanBase.match(/url=(.*)/);
                                if(match) cleanBase = decodeURIComponent(match[1]);
                            }
                            if(!cleanBase.endsWith('/')) cleanBase += '/';

                            const targetUrl = `${cleanBase}${dateURLPart}`;
                            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
                            
                            // log(`   Target: ${targetUrl}`);
                            const res = await fetch(proxyUrl);
                            if (res.ok) {
                                const jsonRes = await res.json(); // AllOrigins ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ó‡∏µ‡πà‡∏°‡∏µ contents
                                const htmlContent = jsonRes.contents; // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ HTML ‡∏î‡∏¥‡∏ö‡πÜ
                                
                                // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏Å‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                                externalData = parseHTMLTable(htmlContent, dateDBStr);
                                log(`   ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á HTML: ‡∏û‡∏ö ${externalData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'info');
                            } else {
                                log(`   ‚ö†Ô∏è Proxy ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (Status: ${res.status})`);
                            }
                        } catch (e) {
                            console.error(e);
                            log(`   ‚ùå ‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏≠‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)`, 'error');
                        }
                    }

                    // 3.2 ‡∏î‡∏∂‡∏á DB ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô
                    const { data: internalData } = await sbClient
                        .from(TAS_CONFIG.TABLE_SOURCE).select('*').eq('work_date', dateDBStr);
                    
                    log(`   ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Web): ‡∏û‡∏ö ${internalData ? internalData.length : 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

                    // 3.3 ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Merge)
                    const mergedMap = {};
                    const processRecord = (rec) => {
                        const pid = rec.personnel_id;
                        if (!mergedMap[pid]) {
                            mergedMap[pid] = {
                                personnel_id: pid,
                                full_name: rec.full_name || rec.name,
                                work_date: dateDBStr,
                                time_in: rec.time_in,
                                time_out: rec.time_out
                            };
                        } else {
                            const current = mergedMap[pid];
                            // Logic: ‡πÄ‡∏ä‡πâ‡∏≤‡∏™‡∏∏‡∏î / ‡∏î‡∏∂‡∏Å‡∏™‡∏∏‡∏î
                            if (rec.time_in && (!current.time_in || rec.time_in < current.time_in)) current.time_in = rec.time_in;
                            if (rec.time_out && (!current.time_out || rec.time_out > current.time_out)) current.time_out = rec.time_out;
                        }
                    };

                    if (externalData.length > 0) externalData.forEach(processRecord);
                    if (internalData && internalData.length > 0) internalData.forEach(processRecord);

                    const finalData = Object.values(mergedMap);

                    // 3.4 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    if (finalData.length > 0) {
                        const recordsToSave = finalData.map(item => ({
                            id: `${dateURLPart}${item.personnel_id}`, // ID ‡∏™‡∏π‡∏ï‡∏£: DDMMYYYY + ID
                            personnel_id: item.personnel_id,
                            full_name: item.full_name,
                            work_date: item.work_date,
                            time_in: item.time_in,
                            time_out: item.time_out,
                            verified: 0
                        }));

                        const { error: errUpsert } = await sbClient
                            .from(TAS_CONFIG.TABLE_TARGET)
                            .upsert(recordsToSave, { onConflict: 'personnel_id, work_date' });

                        if (errUpsert) log(`   ‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${errUpsert.message}`, 'error');
                        else log(`   üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${recordsToSave.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                    } else {
                        log(`   (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)`);
                    }

                    loopDate.setDate(loopDate.getDate() + 1);
                }

                log(`-----------------------------------`);
                log(`‚úÖ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!`, 'highlight');
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á HTML ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');

            } catch (err) {
                console.error(err);
                log(`‚ùå Error: ${err.message}`, 'error');
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
