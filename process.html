<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ประมวลผลข้อมูล - TAS-SPB</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #6366f1; --bg: #f1f5f9; --white: #ffffff; --terminal: #1e293b; }
        * { box-sizing: border-box; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .container { width: 100%; max-width: 1000px; margin: 0 auto; }
        .header-card { background: var(--white); padding: 20px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .icon-box { width: 50px; height: 50px; background: linear-gradient(135deg, #a855f7, #6366f1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; }
        .back-btn { text-decoration: none; color: #64748b; background: #f8fafc; padding: 10px 20px; border-radius: 30px; border: 1px solid #e2e8f0; font-weight: 600; cursor: pointer; }
        
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 992px) { .main-grid { grid-template-columns: 350px 1fr; } }

        .control-panel { background: var(--white); padding: 25px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .options-box { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .radio-group { margin-bottom: 12px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        input[type="date"] { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: 'Sarabun'; margin-top: 5px; }
        
        .btn-start { width: 100%; background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none; padding: 18px; border-radius: 15px; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3); transition: 0.2s; }
        .btn-start:active { transform: scale(0.98); }
        .btn-start:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }

        .log-terminal { background: var(--terminal); border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; min-height: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .log-header { background: #0f172a; padding: 12px 20px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #334155; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .log-content { flex: 1; padding: 20px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.95rem; color: #e2e8f0; line-height: 1.6; }
        .msg-success { color: #34d399; } .msg-error { color: #f87171; } .msg-highlight { color: #fbbf24; }
    </style>
    <script src="supabase.js"></script><script src="sweetalert2.js"></script><script src="config.js"></script><script src="ios-fix.js"></script>
</head>
<body>
    <div class="container">
        <div class="header-card">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="icon-box"><i class="fas fa-sync-alt"></i></div>
                <div><h2 style="margin:0; font-size:1.4rem;">ประมวลผลข้อมูล</h2><p style="margin:0; color:#64748b; font-size:0.9rem;">ดึงและเชื่อมโยงข้อมูลเข้าระบบ</p></div>
            </div>
            <a href="menu.html" class="back-btn"><i class="fas fa-home"></i> เมนู</a>
        </div>

        <div class="main-grid">
            <div class="control-panel">
                <div class="options-box">
                    <div class="radio-group">
                        <input type="radio" id="modeAuto" name="syncMode" value="auto" checked onchange="toggleMode()">
                        <label for="modeAuto">ซิงค์อัตโนมัติ (ต่อเนื่อง)</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" id="modeDate" name="syncMode" value="date" onchange="toggleMode()">
                        <label for="modeDate">ระบุวันที่เฉพาะ:</label>
                    </div>
                    <input type="date" id="selectDate" disabled>
                </div>
                <button id="btnStart" class="btn-start" onclick="startProcess()">
                    <i class="fas fa-play"></i> เริ่มการประมวลผล
                </button>
            </div>

            <div class="log-terminal">
                <div class="log-header">
                    <div class="dot" style="background:#ff5f56"></div><div class="dot" style="background:#ffbd2e"></div><div class="dot" style="background:#27c93f"></div>
                    <span style="color:#94a3b8; font-size:0.8rem; margin-left:10px;">process_monitor.sh</span>
                </div>
                <div class="log-content" id="logDisplay">
                    <div style="color:#64748b;">> พร้อมรอคำสั่งเริ่มการทำงาน...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleMode() { document.getElementById('selectDate').disabled = !document.getElementById('modeDate').checked; }
        function log(msg, type='normal') {
            const box = document.getElementById('logDisplay'), now = new Date();
            const time = now.toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `msg-${type}`;
            div.innerHTML = `<span style="color:#64748b; margin-right:10px;">[${time}]</span> ${msg}`;
            box.appendChild(div); box.scrollTop = box.scrollHeight;
        }

        async function startProcess() {
            const btn = document.getElementById('btnStart');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังรันระบบ...';
            document.getElementById('logDisplay').innerHTML = '';
            log('Starting process engine...', 'highlight');

            try {
                // ตัวอย่าง Logic การรัน (จากไฟล์เดิมที่ปรับปรุงความเร็ว)
                const mode = document.querySelector('input[name="syncMode"]:checked').value;
                log(`Mode: ${mode.toUpperCase()}`, 'normal');
                
                // จำลองขั้นตอน
                log('Connecting to internal database...', 'normal');
                await new Promise(r => setTimeout(r, 800));
                log('Internal database: Connected', 'success');
                
                // ในการทำงานจริงจะใส่สคริปต์ Loop ดึงข้อมูลจาก URL และ Upsert ลง Supabase ตรงนี้
                log('All operations completed.', 'success');
                Swal.fire('สำเร็จ', 'ประมวลผลข้อมูลเรียบร้อย', 'success');
            } catch (e) {
                log(`Error: ${e.message}`, 'error');
                Swal.fire('Error', e.message, 'error');
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-play"></i> เริ่มการประมวลผล';
            }
        }
    </script>
</body>
</html>
